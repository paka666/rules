name: Normalize files (UTF-8 + LF)
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 20 * * *"
  workflow_dispatch:

jobs:
  normalize:
    runs-on: ubuntu-latest
    env:
      PAT: ${{ secrets.ALL }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git config
        run: |
          git config --global core.autocrlf input
          git config --global core.eol lf
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Stop if this is an auto-normalization commit
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          if echo "$COMMIT_MSG" | grep -q "auto-normalize files"; then
            echo "‚è© Skipping normalization (already normalized)."
            exit 0
          fi

      - name: Ensure .gitattributes exists (Idempotent)
        run: |
          touch .gitattributes
          grep -qxF '* text eol=lf' .gitattributes || echo '* text eol=lf' >> .gitattributes
          grep -qxF '*.png binary' .gitattributes || echo '*.png binary' >> .gitattributes
          grep -qxF '*.jpg binary' .gitattributes || echo '*.jpg binary' >> .gitattributes
          grep -qxF '*.gif binary' .gitattributes || echo '*.gif binary' >> .gitattributes
          grep -qxF '*.pdf binary' .gitattributes || echo '*.pdf binary' >> .gitattributes
          grep -qxF '*.zip binary' .gitattributes || echo '*.zip binary' >> .gitattributes

      - name: Install encoding tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix enca file

      - name: Normalize text files to UTF-8 + LF
        shell: bash
        run: |
          echo "üîç Determining scan scope based on trigger..."
          files=()
          fixed_files=()
          scan_list=()
          trigger="${{ github.event_name }}"

          if [ "$trigger" = "push" ]; then
            echo "üì• Push detected: Scanning only changed files in this push."
            git diff --name-only ${{ github.event.before }} ${{ github.event.after }} > changed_files.txt 2>/dev/null || {
              echo "‚ö†Ô∏è Could not get push diff (e.g., force push?), falling back to last commit diff."
              git diff --name-only HEAD~1 HEAD > changed_files.txt 2>/dev/null || {
                echo "‚ö†Ô∏è Could not get last commit diff, falling back to full scan."
                git ls-files > changed_files.txt
              }
            }
            while IFS= read -r f; do
              if [ -f "$f" ]; then
                scan_list+=("$f")
              fi
            done < changed_files.txt
            rm -f changed_files.txt
          else
            echo "üõ†Ô∏è Manual/scheduled run: Scanning entire repository."
            scan_list=($(find . -type f \
              -not -path "./.git/*" \
              -not -path "./node_modules/*" \
              -not -path "./venv/*"))
          fi
          echo "üìÇ Files to scan: ${#scan_list[@]}"
          for f in "${scan_list[@]}"; do
            mime=$(file -bi "$f" 2>/dev/null || true)
            if [ -z "$mime" ] || ! echo "$mime" | grep -q "text/" || file "$f" | grep -q "executable"; then
              continue
            fi
            encoding=$(echo "$mime" | sed -n 's/.*charset=\(.*\)$/\1/p')
            if [ "$encoding" != "utf-8" ] && [ "$encoding" != "us-ascii" ] && [ "$encoding" != "unknown-8bit" ]; then
              echo "üß© Converting $f from $encoding ‚Üí UTF-8"
              iconv -f "$encoding" -t utf-8//IGNORE "$f" -o "$f.tmp" && mv "$f.tmp" "$f" || echo "‚ö†Ô∏è Failed to convert $f" >&2
            fi
            dos2unix -q "$f" 2>/dev/null
            post_mime=$(file -bi "$f")
            if ! echo "$post_mime" | grep -qE "utf-8|us-ascii"; then
              echo "‚ö†Ô∏è Potential garbled content in $f after conversion (reverting changes)" >&2
              git checkout -- "$f" || true
            fi
            if ! git diff --quiet "$f"; then
              fixed_files+=("$f")
            fi
          done

          if [ ${#fixed_files[@]} -gt 0 ]; then
            echo "‚úÖ Fixed files:"
            for file in "${fixed_files[@]}"; do
              echo "- $file"
            done
            git add "${fixed_files[@]}"
          else
            echo "‚úÖ No files needed fixing."
          fi

      - name: Git commit & push
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "chore: auto-normalize files to UTF-8 + LF"
          git remote set-url origin https://x-access-token:${{ secrets.ALL }}@github.com/${{ github.repository }}
          git push origin main
            echo "‚úÖ Normalization done and pushed."
          else
            echo "‚úÖ No issues found; everything already normalized."
          fi

      - name: Handle errors gracefully
        if: ${{ failure() }}
        run: echo "‚ùå Normalization encountered issues; check logs for details."
