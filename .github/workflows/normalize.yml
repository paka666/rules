name: Normalize files (UTF-8 + LF)

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 20 * * *"
  workflow_dispatch:

jobs:
  normalize:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ALL }}

      - name: Set Git config
        run: |
          git config --global core.autocrlf input
          git config --global core.eol lf
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Stop if this is an auto-normalization commit
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          if echo "$COMMIT_MSG" | grep -q "auto-normalize files"; then
            echo "â© Skipping normalization (already normalized)."
            exit 0
          fi

      - name: Ensure .gitattributes exists (Idempotent)
        run: |
          touch .gitattributes
          grep -qxF '* text eol=lf' .gitattributes || echo '* text eol=lf' >> .gitattributes
          grep -qxF '*.png binary' .gitattributes || echo '*.png binary' >> .gitattributes
          grep -qxF '*.jpg binary' .gitattributes || echo '*.jpg binary' >> .gitattributes
          grep -qxF '*.gif binary' .gitattributes || echo '*.gif binary' >> .gitattributes
          grep -qxF '*.pdf binary' .gitattributes || echo '*.pdf binary' >> .gitattributes
          grep -qxF '*.zip binary' .gitattributes || echo '*.zip binary' >> .gitattributes

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libre2-dev dos2unix enca file uchardet parallel

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r py/requirements.txt

      - name: Normalize text files to UTF-8 + LF
        shell: bash
        run: |
          echo "ğŸ” Determining scan scope based on trigger..."
          files=()
          fixed_files=()
          scan_list=()
          trigger="${{ github.event_name }}"
          if [ "$trigger" = "push" ]; then
            echo "ğŸ“¥ Push detected: Scanning only changed files in this push."
            git diff --name-only ${{ github.event.before }} ${{ github.event.after }} > changed_files.txt 2>/dev/null || {
              echo "âš ï¸ Could not get push diff (e.g., force push?), falling back to last commit diff."
              git diff --name-only HEAD~1 HEAD > changed_files.txt 2>/dev/null || {
                echo "âš ï¸ Could not get last commit diff, falling back to full scan."
                git ls-files > changed_files.txt
              }
            }
            while IFS= read -r f; do
              if [ -f "$f" ]; then
                scan_list+=("$f")
              fi
            done < changed_files.txt
            rm -f changed_files.txt
          else
            echo "ğŸ› ï¸ Manual/scheduled run: Scanning entire repository."
            # ä½¿ç”¨ find -print0 å’Œ read -d $'\0' æ¥å®‰å…¨å¤„ç†åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦çš„æ–‡ä»¶å
            while IFS= read -r -d $'\0' f; do
              scan_list+=("$f")
            done < <(find . -type f \
              -not -path "./.git/*" \
              -not -path "./node_modules/*" \
              -not -path "./venv/*" -print0)
          fi
          echo "ğŸ“‚ Files to scan: ${#scan_list[@]}"

          # å®šä¹‰å¤„ç†å•ä¸ªæ–‡ä»¶çš„å‡½æ•°ï¼ˆæ”¯æŒå¹¶è¡Œï¼‰
          process_file() {
            local f="$1"
            local mime=$(file -bi "$f" 2>/dev/null || true)
            if [ -z "$mime" ] || ! echo "$mime" | grep -q "text/" || file "$f" | grep -q "executable"; then
              return
            fi

            # ç»¼åˆæ£€æµ‹ç¼–ç ï¼šuchardet ä¸»ï¼Œfallback enca&chardetå¸¦ç½®ä¿¡åº¦ï¼Œåˆ—è¡¨å°è¯•
            local encoding=$(uchardet "$f" 2>/dev/null | tr -d ' ')
            if [ -z "$encoding" ] || [ "$encoding" = "UNKNOWN" ] || [ "$encoding" = "unknown-8bit" ]; then
              encoding=$(enca -L none "$f" 2>/dev/null | grep -oP '(?<=Encoding: ).*')
              if [ -z "$encoding" ] || echo "$encoding" | grep -q "Unrecognized"; then
                encoding=$(python3 -c "import textwrap; exec(textwrap.dedent('\n' + '''
                  import chardet
                  import sys
                  f = sys.argv[1]
                  with open(f, 'rb') as file:
                      raw = file.read()
                      result = chardet.detect(raw)
                      if result['confidence'] > 0.7:
                          print(result['encoding'])
                      else:
                          print('UNKNOWN')
                  '''))" "$f" 2>/dev/null)
              fi
            fi

            # å¦‚æœä»æœªçŸ¥ï¼Œå°è¯•å¸¸è§ fallback ç¼–ç åˆ—è¡¨å¹¶éªŒè¯è½¬æ¢
            if [ -z "$encoding" ] || [ "$encoding" = "UNKNOWN" ] || [ "$encoding" = "unknown-8bit" ]; then
              local possible_encodings=("WINDOWS-1252" "ISO-8859-1" "CP1252" "WINDOWS-1254" "UTF-16LE" "UTF-16BE")
              for enc in "${possible_encodings[@]}"; do
                if iconv -f "$enc" -t utf-8//IGNORE "$f" -o /dev/null 2>/dev/null; then
                  encoding="$enc"
                  break
                fi
              done
              if [ -z "$encoding" ] || [ "$encoding" = "UNKNOWN" ]; then
                echo "âš ï¸ Skipping $f: Unable to determine encoding reliably." >&2
                return
              fi
            fi

            # æ ‡å‡†åŒ–ç¼–ç åç§°ï¼ˆchardet/uchardet å¯èƒ½è¾“å‡ºå˜ä½“ï¼Œå¦‚ ascii â†’ us-asciiï¼‰
            if [ "$encoding" = "ascii" ]; then encoding="us-ascii"; fi
            if [ "$encoding" = "UTF-8" ]; then encoding="utf-8"; fi

            if [ "$encoding" != "utf-8" ] && [ "$encoding" != "us-ascii" ]; then
              echo "ğŸ§© Converting $f from $encoding â†’ UTF-8"
              iconv -f "$encoding" -t utf-8//IGNORE "$f" -o "$f.tmp" && mv "$f.tmp" "$f" || {
                echo "âš ï¸ Failed to convert $f" >&2
                return
              }
            fi

            # è§„èŒƒåŒ–è¡Œå°¾ï¼ˆLFï¼‰
            dos2unix -q "$f" 2>/dev/null

            # åç½®éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦ä¹±ç ï¼ˆæ‰©å±•ï¼šæ£€æŸ¥æ›¿æ¢å­—ç¬¦æ¯”ä¾‹ï¼‰
            local post_mime=$(file -bi "$f")
            if ! echo "$post_mime" | grep -qE "utf-8|us-ascii"; then
              echo "âš ï¸ Potential garbled content in $f after conversion (reverting changes)" >&2
              git checkout -- "$f" || true
              return
            fi

            # é¢å¤–ä¹±ç æ£€æŸ¥ï¼šå¦‚æœæ–‡ä»¶ä¸­æœ‰è¿‡å¤š ï¿½ (U+FFFD)ï¼Œè§†ä¸ºå¤±è´¥
            local replacement_count=$(grep -o 'ï¿½' "$f" | wc -l)
            local total_chars=$(wc -c < "$f")
            if [ "$total_chars" -gt 0 ] && [ $((replacement_count * 100 / total_chars)) -gt 5 ]; then  # >5% æ›¿æ¢å­—ç¬¦
              echo "âš ï¸ High replacement chars in $f (reverting)" >&2
              git checkout -- "$f" || true
              return
            fi

            # å¦‚æœæœ‰å˜åŒ–ï¼Œæ ‡è®°ä¸º fixed
            if ! git diff --quiet "$f"; then
              echo "$f"  # è¾“å‡ºä»¥æ”¶é›† fixed_files
            fi
          }
          export -f process_file

          # å¹¶è¡Œå¤„ç†æ–‡ä»¶ï¼ˆä½¿ç”¨ parallelï¼Œé™åˆ¶ jobs ä»¥é¿å… OOMï¼Œe.g., 4 å¹¶è¡Œï¼‰
          echo "ğŸš€ Processing files in parallel..."
          fixed_files=($(parallel -j4 process_file ::: "${scan_list[@]}" | grep -v '^âš ï¸' | grep -v '^ğŸ§©'))

          if [ ${#fixed_files[@]} -gt 0 ]; then
            echo "âœ… Fixed files:"
            for file in "${fixed_files[@]}"; do
              echo "- $file"
            done
            git add "${fixed_files[@]}"
          else
            echo "âœ… No files needed fixing."
          fi

      - name: Git commit & push
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "chore: auto-normalize files to UTF-8 + LF"
            git push
            echo "âœ… Normalization done and pushed."
          else
            echo "âœ… No issues found; everything already normalized."
          fi

      - name: Handle errors gracefully
        if: ${{ failure() }}
        run: echo "âŒ Normalization encountered issues; check logs for details."
